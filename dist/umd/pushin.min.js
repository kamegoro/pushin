!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).pushin={})}(this,(function(t){"use strict";const e=[768,1440,1920],s="data-pushin-layer-index";class i{getStringOption(t,e=this.container){let s;const i=this.getAttributeName(t);if(null==e?void 0:e.hasAttribute(i))s=e.getAttribute(i);else if("string"==typeof this.settings[t])s=this.settings[t];else if("number"==typeof this.settings[t])s=this.settings[t].toString();else if(this.settings[t]){"[object Array]"===Object.prototype.toString.call(this.settings[t])&&(s=this.settings[t])}else s="";return"string"==typeof s&&s.includes(",")&&(s=s.split(",")),s}getNumberOption(t,e=this.container){let s=null;const i=this.getAttributeName(t);return(null==e?void 0:e.hasAttribute(i))?s=e.getAttribute(i):this.settings[t]&&(s=this.settings[t]),"string"==typeof s&&(s=s.split(",").map((t=>parseFloat(t))),s=s.length>1?s:s[0]),s}getBoolOption(t,e=this.container){let s=null;const i=this.getAttributeName(t);return(null==e?void 0:e.hasAttribute(i))?s=e.getAttribute(i):this.settings[t]&&(s=this.settings[t]),"string"==typeof s&&(s=s.split(",").map((t=>"false"!==t&&!!t)),s=s.length>1?s:s[0]),s}getAttributeName(t){return`data-pushin-${t.replace(/[A-Z]+(?![a-z])|[A-Z]/g,((t,e)=>(e?"-":"")+t.toLowerCase()))}`}}class n extends i{constructor(t,e){var s;super(),this.scene=t,this.options=e,this.settings=e;const i=this.scene.container.querySelector(".pushin-composition");i?this.container=i:(null===(s=this.settings)||void 0===s?void 0:s.ratio)&&(this.container=document.createElement("div"),this.container.classList.add("pushin-composition"),this.container.innerHTML=this.scene.container.innerHTML,this.scene.container.innerHTML="",this.scene.container.appendChild(this.container),this.scene.pushin.cleanupFns.push((()=>{this.scene.container.innerHTML=this.container.innerHTML}))),this.container&&this.setRatio()}setRatio(){let t=this.getNumberOption("ratio");if("number"==typeof t&&(t=[t,t]),t){const e=100*t.reduce(((t,e)=>e/t));this.container.style.paddingTop=`${e.toString()}%`}}}class r extends i{constructor(t,e,s,i){super(),this.container=t,this.index=e,this.scene=s,this.settings=i;const n=this.getInpoints(this.container,this.index),r=this.getOutpoints(this.container,n[0]),o=this.getSpeed(this.container);this.originalScale=this.getElementScaleX(this.container),this.ref={inpoints:n,outpoints:r,speed:o},this.container.setAttribute("data-pushin-layer-index",this.index.toString()),this.container.setAttribute("tabindex","0"),this.setLayerParams()}getTransitions(){var t,e;let s=null===(e=null===(t=this.settings)||void 0===t?void 0:t.transitions)||void 0===e||e;if(this.container.hasAttribute("data-pushin-transitions")){const t=this.container.dataset.pushinTransitions;t&&(s="false"!==t&&"0"!==t)}return s}getOverlap(){let t=0;if(this.index>0){const e=this.scene.layers[this.index-1].params.transitionEnd,s=this.getTransitionStart(),i=(s+e)/2;t=Math.min(.5*i,s)}return t}getTransitionStart(){let t=this.getNumberOption("transitionStart");null!==t&&"number"!=typeof t&&([t]=t);return null===t?200:t}getTransitionEnd(){let t=this.getNumberOption("transitionEnd");null!==t&&"number"!=typeof t&&([t]=t);return null===t?200:t}getInpoints(t,e){var s;let i=[this.scene.getTop()];if(t.dataset.pushinFrom)i=t.dataset.pushinFrom.split(",").map((t=>parseInt(t.trim(),10)));else if(null===(s=this.settings)||void 0===s?void 0:s.inpoints)i=this.settings.inpoints;else if(0===e)i=this.scene.getInpoints();else if(e>0){const{outpoint:t}=this.scene.layers[e-1].params;i=[t-this.getOverlap()]}return i}getOutpoints(t,e){var s;let i=[e+this.scene.layerDepth];if(t.dataset.pushinTo){i=t.dataset.pushinTo.split(",").map((t=>parseInt(t.trim(),10)))}else(null===(s=this.settings)||void 0===s?void 0:s.outpoints)&&(i=this.settings.outpoints);return i}getSpeed(t){var e;let s=null;return t.dataset.pushinSpeed?(s=parseFloat(t.dataset.pushinSpeed),Number.isNaN(s)&&(s=8)):(null===(e=this.settings)||void 0===e?void 0:e.speed)&&(s=this.settings.speed),s||8}setZIndex(t){this.container.style.zIndex=(t-this.index).toString()}setLayerParams(){this.params={depth:this.getDepth(),inpoint:this.getInpoint(this.ref.inpoints),outpoint:this.getOutpoint(this.ref.outpoints),overlap:this.getOverlap(),speed:this.ref.speed,transitions:this.getTransitions(),transitionStart:this.getTransitionStart(),transitionEnd:this.getTransitionEnd()}}getDepth(){return this.getOutpoint(this.ref.outpoints)-this.getInpoint(this.ref.inpoints)}getElementScaleX(t){const e=window.getComputedStyle(t).getPropertyValue("transform");let s=1;if(e&&"none"!==e){const t=e.match(/[matrix|scale]\(([\d,.\s]+)/);if(t&&t[1]){const e=t[1].split(", ");s=parseFloat(e[0])}}return s}isActive(){const{inpoint:t}=this.params,{outpoint:e}=this.params;let s=!0;if(this.params.transitions){const i=this.scene.pushin.scrollY>=t,n=this.scene.pushin.scrollY<=e;s=i&&n,(!s&&this.params.transitionStart<0&&!i||!s&&this.params.transitionEnd<0&&!n)&&(s=!0)}return s}getInpoint(t){const{breakpoints:e}=this.scene.settings;return t[this.scene.getBreakpointIndex(e)]||t[0]}getOutpoint(t){const{breakpoints:e}=this.scene.settings;return t[this.scene.getBreakpointIndex(e)]||t[0]}getScaleValue(t){const e=(this.scene.pushin.scrollY-t.params.inpoint)*(Math.min(t.params.speed,100)/100)/100;return Math.max(t.originalScale+e,0)}setScale(t){const{style:e}=this.container,s=`scale(${t})`;e.webkitTransform=s,e.mozTransform=s,e.msTransform=s,e.oTransform=s,e.transform=s}setLayerStyle(){let t=0;const e=0===this.index,s=this.index+1===this.scene.layers.length,{inpoint:i}=this.params,{outpoint:n}=this.params;if(e&&this.scene.pushin.scrollY<i)t=1;else if(s&&this.scene.pushin.scrollY>n)t=1;else if(this.isActive()){let r=Math.max(Math.min(this.scene.pushin.scrollY-i,this.params.transitionStart),0)/this.params.transitionStart;(e||this.params.transitionStart<0)&&(r=1);let o=Math.max(Math.min(n-this.scene.pushin.scrollY,this.params.transitionEnd),0)/this.params.transitionEnd;(s||this.params.transitionEnd<0)&&(o=1),t=this.params.transitions?Math.min(r,o):1}this.isActive()&&this.setScale(this.getScaleValue(this)),this.container.style.opacity=t.toString()}setLayerVisibility(){parseFloat(this.container.style.opacity)>.1?this.container.classList.add("pushin-layer--visible"):this.container.classList.remove("pushin-layer--visible")}}class o extends i{constructor(t){var e;super(),this.pushin=t,this.settings=t.settings.scene,this.layerDepth=(null===(e=this.settings)||void 0===e?void 0:e.layerDepth)||1e3,this.layers=[]}start(){this.setContainer(),this.setSceneClasses(),this.setComposition(),this.setBreakpoints(),this.getLayers()}setContainer(){const t=this.pushin.container.querySelector(".pushin-scene");t?this.container=t:(this.container=document.createElement("div"),this.container.classList.add("pushin-scene"),this.container.innerHTML=this.pushin.container.innerHTML,this.pushin.container.innerHTML="",this.pushin.container.appendChild(this.container),this.pushin.cleanupFns.push((()=>{this.pushin.container.innerHTML=this.container.innerHTML})))}setComposition(){var t,e;const s={ratio:null!==(e=null===(t=this.pushin.settings.composition)||void 0===t?void 0:t.ratio)&&void 0!==e?e:void 0};this.composition=new n(this,s)}setSceneClasses(){this.pushin.target&&this.container.classList.add("pushin-scene--with-target"),"window"===this.pushin.target.scrollTarget&&this.container.classList.add("pushin-scene--scroll-target-window")}resize(){var t;if("window"!==this.pushin.target.scrollTarget){const e=null===(t=this.pushin.target.container)||void 0===t?void 0:t.getBoundingClientRect();e&&(this.container.style.height=`${e.height}px`,this.container.style.width=`${e.width}px`)}}setBreakpoints(){var t,s;(null===(t=this.settings)||void 0===t?void 0:t.breakpoints)&&0!==(null===(s=this.settings)||void 0===s?void 0:s.breakpoints.length)||(this.settings.breakpoints=[...e]),this.container.dataset.pushinBreakpoints&&(this.settings.breakpoints=this.container.dataset.pushinBreakpoints.split(",").map((t=>parseInt(t.trim(),10)))),this.settings.breakpoints.unshift(0)}getLayers(){var t;const e=Array.from(this.container.getElementsByClassName("pushin-layer"));for(let s=0;s<e.length;s++){const i=e[s];let n={};(null===(t=this.settings)||void 0===t?void 0:t.layers)&&this.settings.layers.length>s&&(n=this.settings.layers[s]);const o=new r(i,s,this,n);this.layers.push(o),o.setZIndex(e.length)}}getBreakpointIndex(t){const e=t.reverse().findIndex((t=>t<=window.innerWidth));return-1===e?0:t.length-1-e}getTop(){let{top:t}=this.container.getBoundingClientRect();return this.pushin.target.container&&(t-=this.pushin.target.container.getBoundingClientRect().top),t}getInpoints(){var t,e;let s=[this.getTop()];if(this.container.dataset.pushinFrom){const t=this.container.dataset.pushinFrom;s.push(parseInt(t,10))}else(null===(e=null===(t=this.settings)||void 0===t?void 0:t.inpoints)||void 0===e?void 0:e.length)>0&&(s=this.settings.inpoints);return s}}class a extends i{constructor(t,e){super(),this.pushin=t,this.settings=e,this.container=null,this.scrollTarget="window",this.height=0}start(){this.setTargetElement(),this.setScrollTarget(),this.setTargetHeight(),this.setTargetOverflow()}setTargetElement(){const t=this.getStringOption("target");if(t){const e=document.querySelector(t);e&&(this.container=e)}this.container&&this.pushin.container.parentElement!==this.container&&this.container.appendChild(this.pushin.container)}setScrollTarget(){const t=this.getStringOption("scrollTarget",this.pushin.container);let e;t&&"string"==typeof t&&(e="window"===t?t:document.querySelector(t)),!e&&this.container&&(e=this.container),e&&(this.scrollTarget=e)}setTargetHeight(){if(this.height=window.innerHeight,this.container){const t=getComputedStyle(this.container).height;this.height=+t.replace("px","")}}setTargetOverflow(){this.container&&"window"!==this.scrollTarget&&(this.container.style.overflowY="scroll",this.container.style.scrollBehavior="smooth")}}class h extends i{constructor(t,e){var s,i,n,r,o,a;super(),this.container=t,this.scrollY=0,this.lastAnimationFrameId=-1,this.cleanupFns=[],e=null!=e?e:{},this.settings={debug:null!==(s=null==e?void 0:e.debug)&&void 0!==s&&s,scene:null!==(i=null==e?void 0:e.scene)&&void 0!==i?i:{breakpoints:[],inpoints:[]},target:null!==(n=null==e?void 0:e.target)&&void 0!==n?n:void 0,scrollTarget:null==e?void 0:e.scrollTarget},this.settings.scene.composition=null!==(r=null==e?void 0:e.composition)&&void 0!==r?r:void 0,this.settings.scene.layers=null!==(o=null==e?void 0:e.layers)&&void 0!==o?o:void 0,this.settings.debug=null!==(a=null==e?void 0:e.debug)&&void 0!==a&&a}start(){this.container?(this.settings.debug&&this.showDebugger(),this.setTarget(),this.scrollY=this.getScrollY(),this.scene=new o(this),this.scene.start(),this.setScrollLength(),this.scene.resize(),"undefined"!=typeof window&&this.bindEvents(),this.toggleLayers()):console.error("No container element provided to pushIn.js. Effect will not be applied.")}setTarget(){const t={};this.settings.target&&(t.target=this.settings.target),this.settings.scrollTarget&&(t.scrollTarget=this.settings.scrollTarget),this.target=new a(this,t),this.target.start()}destroy(){for(cancelAnimationFrame(this.lastAnimationFrameId);this.cleanupFns.length;)this.cleanupFns.pop()()}getScrollY(){var t;let e=0;if("window"===(null===(t=this.target)||void 0===t?void 0:t.scrollTarget)&&"undefined"!=typeof window)e=window.scrollY;else{e=this.target.scrollTarget.scrollTop}return e}bindEvents(){let t=window;"window"!==this.target.scrollTarget&&(t=this.target.scrollTarget);const e=()=>{var t;if(this.scrollY=this.getScrollY(),this.dolly(),this.pushinDebug){const e=null===(t=this.pushinDebug)||void 0===t?void 0:t.querySelector(".pushin-debug__content");e&&(e.textContent=`Scroll position: ${Math.round(this.scrollY)}px`)}};let i;t.addEventListener("scroll",e),this.cleanupFns.push((()=>t.removeEventListener("scroll",e)));const n=()=>{clearTimeout(i),i=window.setTimeout((()=>{this.scene.layers.forEach((t=>t.setLayerParams())),this.setScrollLength(),this.scene.resize(),this.toggleLayers()}),300)};window.addEventListener("resize",n),this.cleanupFns.push((()=>window.removeEventListener("resize",n)));window.addEventListener("focus",(e=>{const i=e.target;if("hasAttribute"in i&&i.hasAttribute(s)){const e=parseInt(i.getAttribute(s),10),n=this.scene.layers[e];if(n){const e=n.params.inpoint+n.params.transitionStart;if("window"===this.target.scrollTarget)window.scrollTo(0,e);else{t.scrollTop=e}}}}),!0)}dolly(){cancelAnimationFrame(this.lastAnimationFrameId),this.lastAnimationFrameId=requestAnimationFrame((()=>{this.toggleLayers()}))}toggleLayers(){this.scene.layers.forEach((t=>{t.setLayerStyle(),t.setLayerVisibility()}))}setScrollLength(){const t=getComputedStyle(this.container).height.replace("px","");let e=0;this.scene.layers.forEach((t=>{e=Math.max(e,t.params.outpoint)})),this.container.style.height=`${Math.max(parseFloat(t),e+this.target.height)}px`}showDebugger(){var t;this.pushinDebug=document.createElement("div"),this.pushinDebug.classList.add("pushin-debug");const e=document.createElement("p");e.innerText="Pushin.js Debugger",e.classList.add("pushin-debug__title");const s=document.createElement("div");s.classList.add("pushin-debug__content"),s.innerText=`Scroll position: ${this.scrollY}px`,this.pushinDebug.appendChild(e),this.pushinDebug.appendChild(s);(null!==(t=this.target.container)&&void 0!==t?t:document.body).appendChild(this.pushinDebug)}}const l=t=>{var e;const s=null!=t?t:{},i=null!==(e=null==t?void 0:t.selector)&&void 0!==e?e:".pushin",n=document.querySelectorAll(i),r=[];for(const t of n){const e=new h(t,s);e.start(),r.push(e)}return r};"undefined"!=typeof window&&(window.pushInStart=l),t.PushIn=h,Object.defineProperty(t,"__esModule",{value:!0})}));
